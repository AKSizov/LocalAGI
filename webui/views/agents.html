<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent List</title>
    {{template "views/partials/header"}}
</head>
<body class="bg-gray-900 p-4 text-white font-sans">
    {{template "views/partials/menu"}}
    <!-- Toast for notifications -->
    <div id="toast" class="toast">
        <span id="toast-message"></span>
    </div>

    <div class="max-w-6xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-6xl font-bold text-primary">Smart Agent List</h1>
        </header>
        <div class="button-container justify-center mb-6">
            <a href="/create" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition duration-300 ease-in-out">
                Add New Agent
            </a>
            <button id="toggle-import" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-300 ease-in-out ml-4">
                Import Agent
            </button>
        </div>
        <section id="import-section" class="hidden mb-8">
            <div class="section-box">
                <h2 class="text-2xl font-bold mb-4">Import Agent</h2>
                <!-- Response Messages Container -->
                <div id="response-container">
                    <!-- Success Alert -->
                    <div id="success-alert" class="alert alert-success">
                        Agent imported successfully! The page will refresh in a moment.
                    </div>
                    <!-- Error Alert -->
                    <div id="error-alert" class="alert alert-error">
                        <span id="error-message">Error importing agent.</span>
                    </div>
                </div>
                <form id='import-form' hx-encoding='multipart/form-data' hx-post='/settings/import' hx-target="#response-container" hx-swap="none">
                    <div class="mb-4">
                        <label for="file" class="block text-gray-300 mb-2">Select Agent File:</label>
                        <input type='file' name='file' id='file' class="bg-gray-700 text-white rounded p-2 w-full">
                    </div>
                    <div class="flex items-center">
                        <button id="import-button" type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-300 ease-in-out">
                            Import Agent
                        </button>
                        <progress id='progress' value='0' max='100' class="ml-4"></progress>
                    </div>
                </form>
            </div>
        </section>
        <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {{ $status := .Status }}
            {{ range .Agents }}
            <div class="card relative flex flex-col items-center text-center p-6 bg-gray-800 rounded-lg shadow-md">
                <img src="/public/agent_{{.}}.png" alt="{{.}}" class="w-24 h-24 rounded-full mb-4">
                <h2 class="text-xl font-bold mb-2">{{.}}</h2>
                <p class="text-gray-400 mb-4">Online: {{ index $status . }}</p>
                <div class="flex justify-center space-x-4">
                    <a href="/status/{{.}}" class="text-indigo-500 hover:text-indigo-400">
                        <i class="fas fa-info-circle"></i> Status
                    </a>
                    <a href="/talk/{{.}}" class="text-indigo-500 hover:text-indigo-400">
                        <i class="fas fa-comments"></i> Talk
                    </a>
                    <button class="action-btn start-btn" hx-put="/start/{{.}}" hx-swap="none" hx-ext="json-enc" data-action="start" data-agent="{{.}}">
                        Start
                    </button>
                    <button class="action-btn pause-btn" hx-put="/pause/{{.}}" hx-swap="none" hx-ext="json-enc" data-action="pause" data-agent="{{.}}">
                        Pause
                    </button>
                    <a href="/settings/{{.}}" class="text-indigo-500 hover:text-indigo-400">
                        <i class="fas fa-cog"></i> Settings
                    </a>
                </div>
            </div>
            {{ end }}
        </section>
        <footer class="mt-8 text-center">
            <p>&copy; 2025 Smart Agent List. All rights reserved.</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const importSection = document.getElementById('import-section');
            const toggleImport = document.getElementById('toggle-import');

            // Toggle import section visibility
            toggleImport.addEventListener('click', function() {
                importSection.classList.toggle('hidden');
            });

            // Handle import form submission
            document.getElementById('import-form').addEventListener('htmx:afterRequest', function(event) {
                const xhr = event.detail.xhr;
                const successAlert = document.getElementById('success-alert');
                const errorAlert = document.getElementById('error-alert');
                const errorMessage = document.getElementById('error-message');
                
                // Hide both alerts initially
                successAlert.style.display = 'none';
                errorAlert.style.display = 'none';
                
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        
                        if (response.status === "ok") {
                            // Show success message
                            successAlert.style.display = 'block';
                            
                            // Refresh the page after a short delay
                            setTimeout(() => {
                                window.location.reload();
                            }, 2000);
                        } else if (response.error) {
                            // Show error message
                            errorMessage.textContent = response.error;
                            errorAlert.style.display = 'block';
                        }
                    } catch (e) {
                        // Handle parsing error
                        errorMessage.textContent = "Invalid response format";
                        errorAlert.style.display = 'block';
                    }
                } else {
                    // Handle HTTP error
                    errorMessage.textContent = "Server error: " + xhr.status;
                    errorAlert.style.display = 'block';
                }
            });

            // Add event listeners for Start and Pause buttons
            document.querySelectorAll('.action-btn').forEach(button => {
                button.addEventListener('htmx:afterRequest', function(event) {
                    const xhr = event.detail.xhr;
                    const action = this.getAttribute('data-action');
                    const agent = this.getAttribute('data-agent');
                    
                    if (xhr.status === 200) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            
                            if (response.status === "ok") {
                                // Show success toast
                                showToast(`Agent "${agent}" ${action === 'start' ? 'started' : 'paused'} successfully`, 'success');
                                
                                // Update the status cell if needed
                                updateAgentStatus(agent, action === 'start' ? true : false);
                            } else if (response.error) {
                                // Show error toast
                                showToast(`Error: ${response.error}`, 'error');
                            }
                        } catch (e) {
                            // Handle parsing error
                            showToast("Invalid response format", 'error');
                        }
                    } else {
                        // Handle HTTP error
                        showToast(`Server error: ${xhr.status}`, 'error');
                    }
                });
            });
        });

        // Function to update agent status in the UI
        function updateAgentStatus(agentName, isOnline) {
            // Find the card for this agent
            const cards = document.querySelectorAll('.card');
            cards.forEach(card => {
                const agentTitle = card.querySelector('h2').textContent;
                if (agentTitle === agentName) {
                    // Update the "Online:" text
                    const statusText = card.querySelector('p');
                    statusText.textContent = `Online: ${isOnline}`;
                }
            });
        }
    </script>
</body>
</html>