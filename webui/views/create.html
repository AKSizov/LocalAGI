<!DOCTYPE html>
<html lang="en">
<head>
    <title>Create New Agent</title>
    {{template "views/partials/header"}}
</head>
<body>
    {{template "views/partials/menu"}}
    <div class="container">
        <div class="section-box">
            <h1>Create New Agent</h1>
            
            <form id="create-agent-form" action="/create" method="POST">
                <div class="mb-4">
                    <label for="name">Name</label>
                    <input type="text" name="name" id="name" placeholder="Name">
                </div>

                <div id="connectorsSection">
                    <!-- Connectors will be added here dynamically -->
                </div>
                
                <div class="button-container">
                    <button type="button" id="addConnectorButton" class="action-btn">
                        <i class="fas fa-plus-circle"></i> Add Connector
                    </button>
                </div>

                <div class="mb-4" id="action_box">
                    <!-- Actions will be added here dynamically -->
                </div>
                
                <div class="button-container">
                    <button id="action_button" type="button" class="action-btn">
                        <i class="fas fa-plus-circle"></i> Add Action
                    </button>
                </div>
           
                <div class="mb-4" id="dynamic_box">
                    <!-- Dynamic prompts will be added here dynamically -->
                </div>
                
                <div class="button-container">
                    <button id="dynamic_button" type="button" class="action-btn">
                        <i class="fas fa-plus-circle"></i> Add Dynamic Prompt
                    </button>
                </div>
             
                <div class="mb-4">
                    <label for="hud" class="checkbox-label">
                        <span class="checkbox-custom">
                            <input type="checkbox" name="hud" id="hud">
                            <span class="checkmark"></span>
                        </span>
                        HUD
                    </label>
                </div>

                <div class="mb-4">
                    <label for="enable_kb" class="checkbox-label">
                        <span class="checkbox-custom">
                            <input type="checkbox" name="enable_kb" id="enable_kb">
                            <span class="checkmark"></span>
                        </span>
                        Enable Knowledge Base
                    </label>
                </div>

                <div class="mb-4">
                    <label for="enable_reasoning" class="checkbox-label">
                        <span class="checkbox-custom">
                            <input type="checkbox" name="enable_reasoning" id="enable_reasoning">
                            <span class="checkmark"></span>
                        </span>
                        Enable Reasoning
                    </label>
                </div>

                <div class="mb-4">
                    <label for="kb_results">Knowledge Base Results</label>
                    <input type="text" name="kb_results" id="kb_results" placeholder="3">
                </div>
        
                <div class="mb-4">
                    <label for="standalone_job" class="checkbox-label">
                        <span class="checkbox-custom">
                            <input type="checkbox" name="standalone_job" id="standalone_job">
                            <span class="checkmark"></span>
                        </span>
                        Standalone Job
                    </label>
                </div>

                <div class="mb-4">
                    <label for="initiate_conversations" class="checkbox-label">
                        <span class="checkbox-custom">
                            <input type="checkbox" name="initiate_conversations" id="initiate_conversations">
                            <span class="checkmark"></span>
                        </span>
                        Initiate Conversations
                    </label>
                </div>

                <div class="mb-4">
                    <label for="can_stop_itself" class="checkbox-label">
                        <span class="checkbox-custom">
                            <input type="checkbox" name="can_stop_itself" id="can_stop_itself">
                            <span class="checkmark"></span>
                        </span>
                        Can Stop Itself
                    </label>
                </div>

                <div class="mb-4">
                    <label for="random_identity" class="checkbox-label">
                        <span class="checkbox-custom">
                            <input type="checkbox" name="random_identity" id="random_identity">
                            <span class="checkmark"></span>
                        </span>
                        Random Identity
                    </label>
                </div>

                <div class="mb-4">
                    <label for="long_term_memory" class="checkbox-label">
                        <span class="checkbox-custom">
                            <input type="checkbox" name="long_term_memory" id="long_term_memory">
                            <span class="checkmark"></span>
                        </span>
                        Long Term Memory
                    </label>
                </div>

                <div class="mb-4">
                    <label for="summary_long_term_memory" class="checkbox-label">
                        <span class="checkbox-custom">
                            <input type="checkbox" name="summary_long_term_memory" id="summary_long_term_memory">
                            <span class="checkmark"></span>
                        </span>
                        Long Term Memory (Summarize!)
                    </label>
                </div>

                <div class="mb-4">
                    <label for="identity_guidance">Identity Guidance</label>
                    <textarea name="identity_guidance" id="identity_guidance" placeholder="Identity Guidance"></textarea>
                </div>

                <div class="mb-4">
                    <label for="periodic_runs">Periodic Runs</label>
                    <input type="text" name="periodic_runs" id="periodic_runs" placeholder="Periodic Runs">
                </div>

                <div class="mb-4">
                    <label for="permanent_goal">Permanent Goal</label>
                    <textarea name="permanent_goal" id="permanent_goal" placeholder="Permanent goal"></textarea>
                </div>

                <div class="mb-4">
                    <label for="system_prompt">System Prompt</label>
                    <textarea name="system_prompt" id="system_prompt" placeholder="System prompt"></textarea>
                </div>

                <button type="submit" id="create-button">
                    <i class="fas fa-robot"></i> Create Agent
                </button>
            </form>
        </div>

        <!-- Response Messages Container -->
        <div id="response-container">
            <!-- Alert messages will be shown here -->
            <div id="success-alert" class="alert alert-success" style="display: none;">
                Agent created successfully! Redirecting to agent list...
            </div>
            
            <div id="error-alert" class="alert alert-error" style="display: none;">
                <span id="error-message">Error creating agent.</span>
            </div>
        </div>
    </div>

    <!-- Toast notification container -->
    <div id="toast" class="toast">
        <span id="toast-message"></span>
    </div>

    <script>
        const actions = `{{ range .Actions }}<option value="{{.}}">{{.}}</option>{{ end }}`;
        const connectors = `{{ range .Connectors }}<option value="{{.}}">{{.}}</option>{{ end }}`;
        const promptBlocks = `{{ range .PromptBlocks }}<option value="{{.}}">{{.}}</option>{{ end }}`;

        // Add connector functionality
        document.getElementById('addConnectorButton').addEventListener('click', function() {
            const connectorsSection = document.getElementById('connectorsSection');
            const newConnectorIndex = connectorsSection.getElementsByClassName('connector').length;
            const newConnectorHTML = `
                <div class="connector mb-4 section-box" style="margin-top: 15px; padding: 15px;">
                    <h2>Connector ${newConnectorIndex + 1}</h2>
                    <div class="mb-4">
                        <label for="connectorType${newConnectorIndex}">Connector Type</label>
                        <select name="connectors[${newConnectorIndex}].type" id="connectorType${newConnectorIndex}">
                            ${connectors}
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="connectorConfig${newConnectorIndex}">Connector Config (JSON)</label>
                        <textarea id="connectorConfig${newConnectorIndex}" name="connectors[${newConnectorIndex}].config" placeholder='{"token":"sk-mg3.."}'>{}</textarea>
                    </div>
                </div>
            `;
        
            connectorsSection.insertAdjacentHTML('beforeend', newConnectorHTML);
        });

        // Add action functionality
        document.getElementById('action_button').addEventListener('click', function() {
            const actionsSection = document.getElementById('action_box');
            const ii = actionsSection.getElementsByClassName('action').length;

            const newActionHTML = `
            <div class="action mb-4 section-box" style="margin-top: 15px; padding: 15px;">
                <h2>Action ${ii + 1}</h2>
                <div class="mb-4">
                    <label for="actionsName${ii}">Action</label>
                    <select name="actions[${ii}].name" id="actionsName${ii}">
                        ${actions}
                    </select>
                </div>
                <div class="mb-4">
                    <label for="actionsConfig${ii}">Action Config (JSON)</label>
                    <textarea id="actionsConfig${ii}" name="actions[${ii}].config" placeholder='{"results":"5"}'>{}</textarea>
                </div>
            </div>
            `;
        
            actionsSection.insertAdjacentHTML('beforeend', newActionHTML);
        });

        // Add dynamic prompt functionality
        document.getElementById('dynamic_button').addEventListener('click', function() {
            const promptsSection = document.getElementById('dynamic_box');
            const ii = promptsSection.getElementsByClassName('promptBlock').length;

            const newPromptHTML = `
            <div class="promptBlock mb-4 section-box" style="margin-top: 15px; padding: 15px;">
                <h2>Prompt Block ${ii + 1}</h2>
                <div class="mb-4">
                    <label for="promptName${ii}">Block Prompt</label>
                    <select name="promptblocks[${ii}].name" id="promptName${ii}">
                        ${promptBlocks}
                    </select>
                </div>
                <div class="mb-4">
                    <label for="promptConfig${ii}">Prompt Config (JSON)</label>
                    <textarea id="promptConfig${ii}" name="promptblocks[${ii}].config" placeholder='{"results":"5"}'>{}</textarea>
                </div>
            </div>
            `;
        
            promptsSection.insertAdjacentHTML('beforeend', newPromptHTML);
        });

        // Form submission handling
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('create-agent-form');
            
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Show a loading state
                const createButton = document.getElementById('create-button');
                const originalButtonText = createButton.innerHTML;
                createButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
                createButton.disabled = true;
                
                // Get form data
                const formData = new FormData(form);
                
                // Send the form data using fetch API
                fetch('/create', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    const successAlert = document.getElementById('success-alert');
                    const errorAlert = document.getElementById('error-alert');
                    const errorMessage = document.getElementById('error-message');
                    
                    // Hide both alerts initially
                    successAlert.style.display = 'none';
                    errorAlert.style.display = 'none';
                    
                    if (data.status === "ok") {
                        // Show success toast
                        showToast('Agent created successfully!', 'success');
                        
                        // Show success message
                        successAlert.style.display = 'block';
                        
                        // Redirect to agent list page after a delay
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 2000);
                    } else if (data.error) {
                        // Show error toast
                        showToast('Error: ' + data.error, 'error');
                        
                        // Show error message
                        errorMessage.textContent = data.error;
                        errorAlert.style.display = 'block';
                        
                        // Restore button state
                        createButton.innerHTML = originalButtonText;
                        createButton.disabled = false;
                    } else {
                        // Handle unexpected response format
                        showToast('Unexpected response format', 'error');
                        errorMessage.textContent = "Unexpected response format";
                        errorAlert.style.display = 'block';
                        
                        // Restore button state
                        createButton.innerHTML = originalButtonText;
                        createButton.disabled = false;
                    }
                })
                .catch(error => {
                    // Handle network or other errors
                    showToast('Network error: ' + error.message, 'error');
                    const errorAlert = document.getElementById('error-alert');
                    const errorMessage = document.getElementById('error-message');
                    
                    errorMessage.textContent = "Network error: " + error.message;
                    errorAlert.style.display = 'block';
                    
                    // Restore button state
                    createButton.innerHTML = originalButtonText;
                    createButton.disabled = false;
                });
            });
        });

        // Add additional CSS for checkbox labels
        document.addEventListener('DOMContentLoaded', function() {
            const style = document.createElement('style');
            style.textContent = `
                .checkbox-label {
                    display: flex;
                    align-items: center;
                    cursor: pointer;
                    margin-bottom: 10px;
                }
                
                .checkbox-label .checkbox-custom {
                    margin-right: 10px;
                }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>
</html>